var Cache=function(){var e=this;this.map=new Map,this.get=function(t,r){let l=e.map.get(t);return l||e.map.set(t,l=r()),l}},safeEvalCache=new Cache;function safeEval(e,t,r){let l=r?e:"return ("+e+")";if(t&&Object.keys(t).length){let e=[];for(let r in t)e.push(r+'=arguments[0]["'+r.replace(/"/g,'"')+'"]');l="var "+e.join(",")+";"+l}try{let e=function(){return Function(l)};return safeEvalCache.get(l,e).call(this,t)}catch(e){if(!(e instanceof TypeError&&e.message.match("undefined")))throw e.message+=' in expression "'+l+'"',e}}var eventNames=Object.keys(document.__proto__.__proto__).filter(e=>e.startsWith("on")).map(e=>e.slice(2)),eventNamesMap={};for(let e of eventNames)eventNamesMap["on"+e]=!0;class XElementError$1 extends Error{constructor(e){super(e)}}var removeProxy=e=>e&&e.$removeProxy||e,arrayEq=(e,t,r)=>!(!e||!t||e.length!==t.length)&&(t=removeProxy(t),removeProxy(e).every((e,l)=>r&&Array.isArray(e)?arrayEq(e,t[l]):removeProxy(e)===removeProxy(t[l]))),csv=e=>JSON.stringify(e).slice(1,-1),isObj=e=>e&&"object"==typeof e,isValidAttribute=(e,t)=>{if(t.startsWith("data-")||t.startsWith("x-")||e.hasAttribute(t)||t.startsWith("on")&&eventNames.includes(t.slice(2)))return!0;if(t in e)return!1;e[t]=1;var r=e.hasAttribute(t);return delete e[t],r},hasKeyStartingWith=(e,t)=>{for(let r in e)if(r.startsWith(t))return!0;return!1},traversePath=(e,t,r,l,i)=>{if(!e&&!r&&t.length)return;let n=0;for(let o of t){let a=n===t.length-1;if(void 0===e[o]){if(!r)return;a||((t[n+1]+"").match(/^\d+$/)?e[o]=[]:e[o]={})}a&&void 0!==l&&(i&&((e=e.$removeProxy||e).$disableWatch=!0),e[o]=l,i&&delete e.$disableWatch),e=e[o],n++}return e},removeProxies=(e,t)=>{if(null==e)return e;if(e.$isProxy&&(e=e.$removeProxy).$isProxy)throw new XElementError$1("Double wrapped proxy found.");if("object"==typeof e){if(t){if(t.has(e))return e}else t=new WeakSet;t.add(e);for(let r in Object.keys(e)){let l=e[r],i=removeProxies(l,t);if(i!==l)if(Object.getOwnPropertyDescriptor(e,r).writable)e[r]=i;else{let t=watch.objects.get(e);(t?t.fields_:e)[r]=i}}}return e},identifier="([$a-z_][$a-z0-9_]*)",dotIdentifier="\\.\\s*"+identifier,varBrD='\\[\\s*"(([^"]|\\")*)"\\s*]',varBrS=varBrD.replace(/"/g,"'"),varNum="\\[\\s*(\\d+)\\s*]",or="\\s*|\\s*",varProp=dotIdentifier+or+varBrD+or+varBrS+or+varNum,or2="\\s*\\(?|^\\s*",varPropOrFunc="^\\s*"+dotIdentifier+or2+varBrD+or2+varBrS+or2+varNum+"\\s*\\(?",isStandaloneVarRegex=new RegExp("^"+identifier+"("+varProp+")*$","i"),isSimpleCallRegex=new RegExp("^"+identifier+"("+varProp+")*\\(","i"),varStartRegex=new RegExp(identifier+"\\s*\\(?","gi"),varPropRegex=new RegExp(varPropOrFunc,"gi"),nonVars="length,NaN,Infinity,caller,callee,prototype,arguments,true,false,null,undefined,break,case,catch,continue,debugger,default,delete,do,else,finally,for,function,if,in,instanceof,new,return,switch,throw,try,typeof,var,void,while,with,class,const,enum,export,extends,import,super".split(/,/g),nonVars2="super,NaN,Infinity,true,false,null,undefined".split(/,/g),isStandaloneVar=e=>!nonVars2.includes(e)&&!!e.trim().match(isStandaloneVarRegex),isStandaloneCall=e=>{var t=(e=e.trim()).indexOf(";");return(-1===t||t===e.length-1)&&(!nonVars2.includes(e)&&!!e.match(isSimpleCallRegex))},parseVars=(e,t,r)=>{for(var l=[],i=0;e.length;){var n=void 0;let o,a=varStartRegex,s=1,c=[];for(c.index_=[];s&&e.length&&(o=a.exec(e));)i+=o.index,e=e.slice(a.lastIndex),a.lastIndex=0,s=(r||!o[0].endsWith("("))&&!nonVars.includes(o[1]),s&&(n=o.filter(Boolean)[1],(t||"this"!==n)&&(c.push(n),c.index_.push({start:i,end:i+n.length})),a=varPropRegex),i+=o[0].length;if(i+=a.lastIndex,a.lastIndex=0,c.length)l.push(c);else if(!o)break}return l},trimThis=function(e){return e.replace(/^this\./,"")},replaceVars=(e,t)=>{Array.isArray(t)||(t=[t]);for(let l of t)for(let t in l){var r=parseVars(e,1);for(let i of r.reverse())if(i.length>=1&&i[0]===t){e="this"===l[t]?i[1]+(i.length>2?e.slice(i.index_[2].start):""):e.slice(0,i.index_[0].start)+l[t]+e.slice(i.index_[0].end)}}return e},parseObj=e=>{let t={},r=e.split(/\s*;\s*/);for(let e of r){var l=e.indexOf(":");let r=e.slice(l+1).trim();if(r){t[e.slice(0,l).trim()]=r}}return t},parseLoop=e=>{var t=e.split(/[,:](?=[^:]+$)/).map(e=>e.trim());if(t[2]&&(t=[t[0],t[2],t[1]]),!isStandaloneVar(t[1]))throw new XElementError('Could not parse loop variable in data-loop attribute "'+e+'".');if(t[2]&&!isStandaloneVar(t[2]))throw new XElementError('Invalid index variable in data-loop attribute "'+e+'".');if(t.length>3)throw new XElementError('Could not parse data-loop attribute "'+e+'".');return t},addThis=(e,t,r,l)=>{if(Array.isArray(t)&&(t=t[0]),l=l||"this",!(r=r||isStandaloneVar)(e))return e;e=e.trim();let i=Object.keys(t||{});for(let t of[l,...i])if(e.match(new RegExp("^"+t+"(s*[.[]|$)")))return e;return l+"."+e};window.parseLoop=parseLoop;var arrayRead=["indexOf","lastIndexOf","includes"],arrayWrite=["push","pop","splice","shift","sort","reverse","unshift"],handler={get(e,t){if("$"===t[0]){if("$removeProxy"===t)return e;if("$isProxy"===t)return!0;if("$trigger"===t)return t=>{let r=WatchUtil.getRoots(e);for(let l of r)WatchUtil.notifyCallbacks(l,"set",t||[],e);return r};if("$roots"===t)return WatchUtil.getRoots(e);if("$subscribers"===t)return Array.from(WatchUtil.getRoots(e)).map(e=>e.callbacks_).reduce((e,t)=>[...e,...t]).map(e=>e("info")).reduce((e,t)=>[...e,...t])}let r=e[t];if(t===Symbol.iterator)return r;if("function"==typeof r){let r=e.$removeProxy||e;return r[t].bind(r)}if(r&&"object"==typeof r){if(r=r.$removeProxy||r,r.$isProxy)throw new XElementError("Double wrapped proxy found.");let l=WatchUtil.getRoots(e);for(let i of l){let l=WatchUtil.getPaths(i,e);for(let e of l)WatchUtil.addPath(i,[...e,t],r)}return WatchUtil.getProxy(r)}return r},set(e,t,r){r=removeProxies(r);let l=e[t];e[t]=r;let i=WatchUtil.getRoots(e);for(let n of i){let i=WatchUtil.getPaths(n,e);for(let e of i){let i=[...e,t];WatchUtil.notifyCallbacks(n,"set",i,r,l)}}return 1},deleteProperty(e,t){Array.isArray(e)?e.splice(t,1):delete e[t];let r=WatchUtil.getRoots(e);for(let l of r){let r=WatchUtil.getPaths(l,e);for(let e of r){let r=[...e,t];WatchUtil.notifyCallbacks(l,"set",r)}}return 1}},WatchUtil={getProxy:function(e){let t=WatchUtil.proxies.get(e);if(!t&&(WatchUtil.proxies.set(e,t=new Proxy(e,handler)),Array.isArray(e))){for(let r of arrayRead)Object.defineProperty(t,r,{enumerable:!1,get:()=>t=>Array.prototype[r].call(e,removeProxy(t))});for(let r of arrayWrite)Object.defineProperty(t,r,{configurable:!0,enumerable:!1,get:()=>function(){let l=e.length;var i=0;"push"===r?i=l:"pop"===r?i=l-1:"splice"===r&&(i=arguments[0]<0?l-arguments[0]:arguments[0]);let n=Array.prototype[r].apply(e,arguments);["splice","shift","sort","reverse","unshift"].includes(r)&&WatchUtil.rebuildArray(e,i,null,null);let o=WatchUtil.getRoots(e);for(let r of o){let n=WatchUtil.getPaths(r,e);for(let o of n){for(var a=i;a<t.length;a++)WatchUtil.notifyCallbacks(r,"set",[...o,a+""],e[a]);for(;a<l;a++)WatchUtil.notifyCallbacks(r,"delete",[...o,a+""])}}return n}})}return t},rebuildArray:function(e,t,r,l){if(r=r||[],void 0===t&&(t=0),!(l=l||new WeakSet).has(e)){if(l.add(e),r.length){let t=WatchUtil.roots.get(e);if(!t)return;for(let l of t){let t=WatchUtil.getPaths(l,e);for(let i in t){let n=t[i],o=n.length-r.length;if(o>=0){let a=n.slice();for(let e=o;e<n.length;e++)a[e]=r[e-o];let s=l;for(let e of a)if(s=s[e],!s)break;s===e&&(t[i]=a)}}}}if(Array.isArray(e))for(let i=t;i<e.length;i++)(Array.isArray(e[i])||isObj(e[i]))&&WatchUtil.rebuildArray(e[i],0,[...r,i+""],l);else if(isObj(e))for(let t in e)(Array.isArray(e[t])||isObj(e[t]))&&WatchUtil.rebuildArray(e[t],0,[...r,t+""],l)}},getRoots:function(e){return e=e.$removeProxy||e,WatchUtil.roots.get(e)||[]},addPath:function(e,t,r){r=r.$removeProxy||r,e=e.$removeProxy||e;let l=WatchUtil.roots.get(r);l||WatchUtil.roots.set(r,l=new Set),l.add(e);let i=WatchUtil.paths.get(e);i||WatchUtil.paths.set(e,i=new WeakMap);let n=i.get(r);if(n){for(let e of n){var o=e.length;if(!(t.length<e.length)){var a=!0;for(let r=0;r<o&&!(a=!(e[r]!==t[r]));r++);if(a)return}}n.push(t)}else i.set(r,[t])},getPaths:function(e,t){if(e.$isProxy)throw new Error("Can't be proxy.");let r=WatchUtil.paths.get(e);return r&&r.get(t.$removeProxy||t)||[]},addCallback:function(e,t){e=e.$removeProxy||e;let r=WatchUtil.callbacks.get(e);r||WatchUtil.callbacks.set(e,r=[]),r.push(t)},getCallbacks:function(e){return e=e.$removeProxy||e,WatchUtil.callbacks.get(e)||[]},notifyCallbacks:function(e,t,r,l,i){let n=WatchUtil.getCallbacks(e);for(let e of n)e(t,r,l,i)},cleanup:()=>{WatchUtil.proxies=new WeakMap,WatchUtil.roots=new WeakMap,WatchUtil.callbacks=new WeakMap,WatchUtil.paths=new WeakMap}};WatchUtil.proxies=new WeakMap,WatchUtil.roots=new WeakMap,WatchUtil.callbacks=new WeakMap,WatchUtil.paths=new WeakMap;var watchProxy=(e,t)=>{if(!isObj(e))throw new XElementError("Can only watch objects");return WatchUtil.addPath(e,[],e),WatchUtil.addCallback(e,t),WatchUtil.getProxy(e)};class WatchProperties{constructor(e){this.obj_=e,this.fields_={},this.proxy_=watchProxy(this.fields_,this.notify_.bind(this)),this.subs_={}}notify_(e,t,r,l){if("info"===e)return this.subs_;let i=csv(t),n=t.slice(0,-1);for(;n.length;){let e=csv(n);if(e in this.subs_)for(let t of this.subs_[e])t.apply(this.obj_,arguments);n.pop()}if(i in this.subs_)for(let e of this.subs_[i])e.apply(this.obj_,arguments);let o=traversePath(this.obj_,t);for(let t in this.subs_)if(t.startsWith(i)&&t.length>i.length){let r=t.slice(i.length>0?i.length+1:i.length),n=JSON.parse("["+r+"]"),a=removeProxy(traversePath(l,n)),s=removeProxy(traversePath(o,n));if(a!==s){let r=this.subs_[t];if(r.length){let l=JSON.parse("["+t+"]");for(let t of r)t.apply(this.obj_,[e,l,s,a])}}}}subscribe_(e,t){e.startsWith&&(e=[e]);var r=this,l=e[0];l in r.fields_||(r.fields_[l]=r.obj_[l],delete r.obj_[l],Object.defineProperty(r.obj_,l,{enumerable:1,configurable:1,get:()=>r.proxy_[l],set:function(e){r.obj_.$disableWatch?r.proxy_.$removeProxy[l]=e:r.proxy_[l]=e}})),traversePath(this.fields_,e,1);let i=csv(e);i in r.subs_||(r.subs_[i]=[]),r.subs_[i].push(t)}unsubscribe_(e,t){e.startsWith&&(e=[e]);let r=csv(e);if(r in this.subs_){if(t){let e=this.subs_[r].indexOf(t);if(-1===e)throw new XElementError$1("Bad index");this.subs_[r].splice(e,1)}if(!t||!this.subs_[r].length){delete this.subs_[r];let t=csv([e[0]]);hasKeyStartingWith(this.subs_,t)||(delete this.obj_[e[0]],this.obj_[e[0]]=this.fields_[e[0]],delete this.fields_[e[0]])}}}}var watch$1=(e,t,r)=>{e=removeProxy(e);var l=watch$1.objects.get(e);l||watch$1.objects.set(e,l=new WatchProperties(e)),l.subscribe_(t,r)};watch$1.objects=new WeakMap;var unwatch=(e,t,r)=>{e=removeProxy(e);var l=watch$1.objects.get(e);if(l){if(t)l.unsubscribe_(t,r);else for(let e in l.subs_)l.unsubscribe_(e);Object.keys(l.subs_).length||watch$1.objects.delete(e)}};watch$1.cleanup=()=>watch$1.objects=new WeakMap;var WeakMultiMap=function(){let e=this;e.items=new WeakMap,e.add=function(t,r){let l=e.items.get(t);l?l.push(r):e.items.set(t,[r])},e.get=function(t){return e.items.get(t)[0]},e.getAll=function(t){return e.items.get(t)||[]},e.remove=function(t){let r=e.items.get(t);if(r)return 1===r.length&&e.items.delete(t),r.pop()},e.removeAll=function(t){return e.items.delete(t)}},createElMap={},createEl=e=>{let t=createElMap[e];if(t)return t.cloneNode(!0);if("string"!=typeof e)throw new XElementError$1("Html argument must be a string.");let r=e.trim().match(/<([a-z0-9-]+)/i);r&&(r=r[1]);let l={td:"tr",tr:"tbody",tbody:"table",thead:"table",tfoot:"table",source:"video",area:"map",legend:"fieldset",option:"select",col:"colgroup",param:"object"}[r]||"div";var i=document.createElement(l);i.innerHTML=e;var n=i.removeChild(i.firstChild);return createElMap[e]=n.cloneNode(!0),n},elWatches=new WeakMultiMap,elEvents=new WeakMultiMap,getXName=e=>{if(!e.xname_){let t="x-"+e.name.toLowerCase().replace(/^x/,"");e.xname_=t;for(let r=2;customElements.get(e.xname_);r++)e.xname_="x-"+t+r}return e.xname_},getXParent=e=>{for(;(e=e.parentNode)&&e&&11!==e.nodeType;);return e?e.host:null},getRootXElement=function(e,t){let r=[e,(t=t.slice()).slice()];for(;e=e[t.shift()];)e instanceof XElement&&(r=[e,t.slice()]);return r},getLoopCode_$1=e=>e.getAttribute&&(e.getAttribute("x-loop")||e.getAttribute("data-loop")),getXAttrib=(e,t)=>e.getAttribute&&(e.getAttribute("x-"+t)||e.getAttribute("data-"+t)),parseXAttrib=e=>e.startsWith("x-")?e.slice(2):e.startsWith("data-")?e.slice(5):null,bindEl=(e,t,r)=>{bindElProps(e,t,r),bindElEvents(e,t,r,!0)},bindElProps=(e,t,r)=>{if(r=(r=r||[]).slice(),t instanceof XElement){if(t!==e)for(let l in t.instantiationAttributes){let i=t.instantiationAttributes[l],n=parseXAttrib(l);if(n&&"prop"!==n){if(!bindings[n])throw new XElementError(l);bindings[n](e,i,t,r)}}t.propContext=(e.propContext||[]).slice();let l=getXAttrib(t,"prop");l?(bindings.prop(e,l,t,r),r=[r[0],...t.propContext]):r=t.propContext.slice();for(let e in t.definitionAttributes){let l=t.definitionAttributes[e],i=parseXAttrib(e);if(i&&"prop"!==i){if(!bindings[i])throw new XElementError(e);bindings[i](t,l,t,r)}}e=t}else if(t.attributes)for(let l of t.attributes){let i=parseXAttrib(l.name);if(i&&"prop"!==i){if(!bindings[i])throw new XElementError(i);bindings[i](e,l.value,t,r)}}if(!getLoopCode_$1(t)){let l=t.shadowRoot||t;for(let t of l.children)bindElProps(e,t,r)}},bindElEvents=(xelement,el,context,recurse,getAttributesFrom)=>{if(getAttributesFrom=getAttributesFrom||el,getAttributesFrom.getAttribute){var attribs=Array.prototype.slice.call(getAttributesFrom.attributes);for(let attrib of attribs)if(attrib.name in eventNamesMap){let eventName=attrib.name.substr(2),originalEventAttrib=attrib.value,code=replaceVars(originalEventAttrib,context),path=parseVars(code,0,1)[0];path&&traversePath(xelement,path)instanceof Function&&(code=addThis(code,context,isStandaloneCall));let callback=function(event){eval(code)}.bind(xelement);el.addEventListener(eventName,callback),elEvents.add(el,[eventName,callback,originalEventAttrib,xelement]),el.removeAttribute(attrib.name)}}if(recurse){let e=el.shadowRoot||el;if(el instanceof XElement&&(xelement=el),!getLoopCode_$1(e))for(let t of e.children)bindElEvents(xelement,t,context,!0)}},unbindEl=(e,t)=>{var r=(t=t||e).shadowRoot||t;for(let t of r.children)unbindEl(t instanceof XElement?t:e,t);if(t.attributes)for(let e of t.attributes)if(e.name.startsWith("x-")||e.name.startsWith("data-")){"x-loop"!==e.name&&"data-loop"!==e.name||!t.loopHtml_||(t.innerHTML=t.loopHtml_,delete t.loopHtml_,delete t.items_,delete t.context_,delete t.propContext);let r=elWatches.getAll(t);for(let e of r)unwatch(...e);elWatches.removeAll(t)}let l=elEvents.getAll(t)||[];for(let r of l)r[3]===e&&(t.removeEventListener(r[0],r[1]),r[2]&&t.setAttribute("on"+r[0],r[2]))},setAttribute=(e,t,r)=>{isValidAttribute(e,t)?e.setAttribute(t,r):r&&r.length>2&&r.startsWith("{")&&r.endsWith("}")?e[t]=safeEval.call(e,r.slice(1,-1)):e[t]=r},initHtml=e=>{if(!e.init_){if(e.init_=1,!e.constructor.html_)throw new XElementError("XElement .html property must be set to a non-empty string.");if(e.parentNode&&getXAttrib(e.parentNode,"loop"))return e.parentNode.loopHtml=e.constructor.html_.trim(),!1;XElement.disableBind++;var t=createEl(e.constructor.html_.trim());XElement.disableBind--;for(let r of t.attributes)e.definitionAttributes[r.name]=r.value;for(let t of e.attributes)e.instantiationAttributes[t.name]=t.value;for(let r of t.attributes)r.name&&setAttribute(e,r.name,r.value);bindElEvents(e,e,null,!1,t);for(let t in e.instantiationAttributes)setAttribute(e,t,e.instantiationAttributes[t]);let n=e.constructor.shadowMode;if(n||(n="open"),"open"===n||"closed"===n)for(e.attachShadow({mode:n});t.firstChild;)e.shadowRoot.insertBefore(t.firstChild,null);else{var r=e.innerHTML,l=t.querySelector("#slot");if(l&&l.removeAttribute("id"),l||!r)for(e.innerHTML="";t.firstChild;)e.appendChild(t.firstChild);r&&((l||e).innerHTML=r)}var i=e.shadowRoot||e;for(let e of i.querySelectorAll("link"))for(let t of document.styleSheets)if(t.href===e.href){e.parentNode.replaceChild(XElement.createEl("<style>"+Array.from(t.cssRules).map(e=>e.cssText).join("\n")+"</style>"),e);break}for(let t of i.querySelectorAll("[id]")){let r=t.getAttribute("id");if(r in e&&e[r]instanceof Function)throw new XElementError('Cannot set property "'+r+'" on "'+e.constructor.name+'" because there is already a class method with the same name.');Object.defineProperty(e,r,{enumerable:1,configurable:1,get:()=>t,set:()=>{throw new XElementError("Property "+r+" not writable")}}),e.shadowRoot||t.removeAttribute("id")}0===XElement.disableBind&&(bindElProps(e,e),bindElEvents(e,i,null,!0)),e.initialized=!0}};class XElement extends HTMLElement{constructor(){try{super()}catch(e){throw e instanceof TypeError&&(e.message+='\nMake sure to set the .html property before instantiating the class "'+this.name+'".'),e}this.parent=void 0,this.definitionAttributes={},this.instantiationAttributes={};let e=getXName(this.constructor),t=this;customElements.get(e)?initHtml(t):customElements.whenDefined(e).then(()=>{initHtml(t)})}getWatchedPaths(e,t){return e=addThis(replaceVars(e,t),t),parseVars(e).map(e=>getRootXElement(this,e))}}Object.defineProperty(XElement,"html",{get:()=>(void 0).html_,set:function(e){return customElements.define(getXName(this),this),this.html_=e.trim()}}),XElement.disableBind=0,XElement.bindings=bindings,XElement.createEl=createEl,XElement.getXParent=getXParent,XElement.removeProxy=removeProxy,XElement.cleanup=()=>{elWatches=new WeakMultiMap,elEvents=new WeakMultiMap},window.xdebug=e=>e,window.xlog=e=>(console.log(e),e);var bindings={attribs:(e,t,r,l)=>{var i=parseObj(t);for(let t in i){let n=addThis(replaceVars(i[t],l),l),o=function(){var l=safeEval.call(e,n,{el:r});!1===l||null==l?r.removeAttribute(t):r.setAttribute(t,l+"")};for(let t of parseVars(n)){let[l,i]=getRootXElement(e,t);watch$1(l,i,o),elWatches.add(r,[e,t,o])}o()}},classes:(e,t,r,l)=>{var i=parseObj(t);for(let t in i){let n=addThis(replaceVars(i[t],l),l),o=()=>{safeEval.call(e,n,{el:r})?r.classList.add(t):(r.classList.remove(t),r.classList.length||r.removeAttribute("class"))};for(let t of parseVars(n)){let[l,i]=getRootXElement(e,t);watch$1(l,i,o),elWatches.add(r,[l,i,o])}o()}},text:(e,t,r,l)=>{t=addThis(replaceVars(t,l),l);let i=()=>{let l=safeEval.call(e,t,{el:r});null==l&&(l=""),r.textContent=l};for(let l of parseVars(t)){let[t,n]=getRootXElement(e,l);watch$1(t,n,i),elWatches.add(r,[t,n,i])}i()},html:(e,t,r,l)=>{t=addThis(replaceVars(t,l),l);let i=()=>{let l=safeEval.call(e,t,{el:r});null==l&&(l=""),r.innerHTML=l};for(let l of parseVars(t)){let[t,n]=getRootXElement(e,l);watch$1(t,n,i),elWatches.add(r,[t,n,i])}i()},loop:(e,t,r,l)=>{l=l||[];let[i,n,o]=parseLoop(t);i=replaceVars(i,l),i=addThis(i,l),r.context_=l;let a=r;r instanceof XElement&&!r.instantiationAttributes["x-loop"]&&!r.instantiationAttributes["data-loop"]&&(a=a.shadowRoot||a);var s=(s,c,d,f,h)=>{if(!a.loopHtml_){if(1!==a.children.length)throw new XElementError$1('x-loop="'+t+'" must have exactly one child html element.  This restriction may be removed in the future.');for(a.loopHtml_=a.children[0].outerHTML.trim();a.lastChild;)a.removeChild(a.lastChild)}if(!a.loopHtml_)throw new XElementError$1('x-loop="'+t+'" rebuildChildren() called before bindEl().');var u=removeProxy(safeEval.call(e,i,{el:r})||[]),p=removeProxy(a.items_||[]);if(!arrayEq(p,u,!0)){for(let e=0;e<a.children.length;e++)a.children[e].index_=e;var m=new Map,b=new Set(u);for(let e=p.length-1;e>=0;e--){let t=p[e],r=a.children[e];b.has(t)?m.has(t)?m.get(t).push(r):m.set(t,[r]):(unbindEl(r),a.removeChild(r))}for(let e=0;e<u.length;e++){let t=a.children[e],r=(m.get(u[e])||[]).pop(),l=!r;t&&t===r||(l&&(XElement.disableBind++,r=createEl(a.loopHtml_),XElement.disableBind--),a.insertBefore(r,t))}for(let e=a.children.length-1;e>=u.length;e--){let t=a.children[e];t&&(unbindEl(t),a.removeChild(t))}for(let t=0;t<a.children.length;t++){let r=a.children[t];if(r.index_!==t){let a={...l[0]};if(n in a)throw new XElementError$1('Loop variable "'+n+'" already used in outer loop.');if(o&&o in a)throw new XElementError$1('Loop index variable "'+o+'" already used in outer loop.');unbindEl(e,r),a[n]=i+"["+t+"]",void 0!==o&&(a[o]=t),r.context_=a,bindEl(e,r,[a,...l.slice(1)])}delete r.index_}if(a.items_=u.slice(),"SELECT"===r.tagName&&r.hasAttribute("x-val")){let t=addThis(replaceVars(r.getAttribute("x-val"),l),l);r.value=safeEval.call(e,t,{el:r})}}};for(let t of parseVars(i)){let[l,i]=getRootXElement(e,t);watch$1(l,i,s),elWatches.add(r,[l,i,s])}s()},prop:(e,t,r,l)=>{if(!l)throw new XElementError$1;if(!Array.isArray(l))throw new XElementError$1;if(!(r instanceof XElement))throw new XElementError$1("The data-prop and x-prop attributes can only be used on XElements in "+t);if(e!==r){r.parent=e;var i=parseObj(t);let n={};for(let o in i){if("this"===o)throw new XElementError$1('Cannot use data-propx or x-prop to bind to "this" as a destination in '+t);let a=i[o];a=trimThis(a),a=replaceVars(a,l),a=addThis(a,l);let s=a.replace(/this\./g,"parent.");s=s.replace(/this$/,"parent"),n[o]=s;let c={configurable:!0,get:function(){return safeEval.call(e,a)}};Object.defineProperty(r,o,c)}l.unshift(n)}},sortable:(e,t,r,l)=>{var i={};if(t){var n=parseObj(t);for(let t in n){let o=addThis(replaceVars(n[t],l),l);i[t]=safeEval.call(e,o,{el:r})}}var o=getLoopCode_(r);if(o){let[t]=parseLoop(o);if(!isStandaloneVar(t))throw new XElementError$1("Cannot bind sortable to non-standalone loop variable.");var a=function(e){if("update"===e.type||"add"===e.type){let t;"clone"===e.pullMode?e.to.removeChild(e.to.children[e.newIndex]):(t=e.to.children[e.newIndex],e.from.insertBefore(t,e.from.children[e.oldIndex]));let r=getLoopElArray_(e.from),l=r;e.from!==e.to&&(l=getLoopElArray_(e.to)),t="clone"===e.pullMode?r[e.oldIndex]:r.splice(e.oldIndex,1)[0],l.splice(e.newIndex,0,t.$removeProxy||t),e.item=e.to.children[e.newIndex]}};let r="setData,onChoose,onUnchoose,onStart,onEnd,onAdd,onUpdate,onSort,onRemove,onFilter,onMove,onClone,onChange".split(/,/g);for(let t of r){let r=i[t];i[t]=function(t){if(a(t),r)return r.call(e,t)}}}Sortable.create(r,i)},val:(e,t,r,l)=>{t=addThis(replaceVars(t,l),l);var i=parseVars(t);if(1===i.length&&isStandaloneVar(t)){let t=()=>{let t="";"checkbox"===r.type?t=r.checked:"value"in r?t=r.value:"string"==typeof r.innerHTML&&(t=r.innerHTML),traversePath(e,i[0],!0,t)};r.addEventListener("input",t),elEvents.add(r,["input",t,null,e])}function n(){let l=safeEval.call(e,t,{el:r});null==l&&(l=""),"checkbox"===r.type?r.checked=1==l:r.hasAttribute("contenteditable")?l!==r.innerHTML&&(r.innerHTML=l):r.value!==l&&(r.value=l)}for(let t of i){let[l,i]=getRootXElement(e,t);watch$1(l,i,n),elWatches.add(r,[l,i,n])}n()},visible:(e,t,r,l)=>{t=addThis(replaceVars(t,l),l);var i=r.style.display;"none"===i&&(i="");let n=()=>{r.style.display=safeEval.call(e,t,{el:r})?i:"none"};for(let l of parseVars(t)){let[t,i]=getRootXElement(e,l);watch$1(t,i,n),elWatches.add(r,[t,i,n])}n()}},getLoopElArray_=(e,t)=>{t=t||getXParent(e);let r=e.context_,l=parseLoop(getLoopCode_(e))[0];return l=addThis(replaceVars(l,r),r),safeEval.call(t,l,{el:e})},elWatches$1=new WeakMultiMap,elEvents$1=new WeakMultiMap,getXName$1=e=>{if(!e.xname_){let t="x-"+e.name.toLowerCase().replace(/^x/,"");e.xname_=t;for(let r=2;customElements.get(e.xname_);r++)e.xname_="x-"+t+r}return e.xname_},getXParent$1=e=>{for(;(e=e.parentNode)&&e&&11!==e.nodeType;);return e?e.host:null},getRootXElement$1=function(e,t){let r=[e,(t=t.slice()).slice()];for(;e=e[t.shift()];)e instanceof XElement$1&&(r=[e,t.slice()]);return r},getLoopCode_$2=e=>e.getAttribute&&(e.getAttribute("x-loop")||e.getAttribute("data-loop")),getXAttrib$1=(e,t)=>e.getAttribute&&(e.getAttribute("x-"+t)||e.getAttribute("data-"+t)),parseXAttrib$1=e=>e.startsWith("x-")?e.slice(2):e.startsWith("data-")?e.slice(5):null,bindEl$1=(e,t,r)=>{bindElProps$1(e,t,r),bindElEvents$1(e,t,r,!0)},bindElProps$1=(e,t,r)=>{if(r=(r=r||[]).slice(),t instanceof XElement$1){if(t!==e)for(let l in t.instantiationAttributes){let i=t.instantiationAttributes[l],n=parseXAttrib$1(l);if(n&&"prop"!==n){if(!bindings[n])throw new XElementError(l);bindings[n](e,i,t,r)}}t.propContext=(e.propContext||[]).slice();let l=getXAttrib$1(t,"prop");l?(bindings.prop(e,l,t,r),r=[r[0],...t.propContext]):r=t.propContext.slice();for(let e in t.definitionAttributes){let l=t.definitionAttributes[e],i=parseXAttrib$1(e);if(i&&"prop"!==i){if(!bindings[i])throw new XElementError(e);bindings[i](t,l,t,r)}}e=t}else if(t.attributes)for(let l of t.attributes){let i=parseXAttrib$1(l.name);if(i&&"prop"!==i){if(!bindings[i])throw new XElementError(i);bindings[i](e,l.value,t,r)}}if(!getLoopCode_$2(t)){let l=t.shadowRoot||t;for(let t of l.children)bindElProps$1(e,t,r)}},bindElEvents$1=(xelement,el,context,recurse,getAttributesFrom)=>{if(getAttributesFrom=getAttributesFrom||el,getAttributesFrom.getAttribute){var attribs=Array.prototype.slice.call(getAttributesFrom.attributes);for(let attrib of attribs)if(attrib.name in eventNamesMap){let eventName=attrib.name.substr(2),originalEventAttrib=attrib.value,code=replaceVars(originalEventAttrib,context),path=parseVars(code,0,1)[0];path&&traversePath(xelement,path)instanceof Function&&(code=addThis(code,context,isStandaloneCall));let callback=function(event){eval(code)}.bind(xelement);el.addEventListener(eventName,callback),elEvents$1.add(el,[eventName,callback,originalEventAttrib,xelement]),el.removeAttribute(attrib.name)}}if(recurse){let e=el.shadowRoot||el;if(el instanceof XElement$1&&(xelement=el),!getLoopCode_$2(e))for(let t of e.children)bindElEvents$1(xelement,t,context,!0)}},unbindEl$1=(e,t)=>{var r=(t=t||e).shadowRoot||t;for(let t of r.children)unbindEl$1(t instanceof XElement$1?t:e,t);if(t.attributes)for(let e of t.attributes)if(e.name.startsWith("x-")||e.name.startsWith("data-")){"x-loop"!==e.name&&"data-loop"!==e.name||!t.loopHtml_||(t.innerHTML=t.loopHtml_,delete t.loopHtml_,delete t.items_,delete t.context_,delete t.propContext);let r=elWatches$1.getAll(t);for(let e of r)unwatch(...e);elWatches$1.removeAll(t)}let l=elEvents$1.getAll(t)||[];for(let r of l)r[3]===e&&(t.removeEventListener(r[0],r[1]),r[2]&&t.setAttribute("on"+r[0],r[2]))},setAttribute$1=(e,t,r)=>{isValidAttribute(e,t)?e.setAttribute(t,r):r&&r.length>2&&r.startsWith("{")&&r.endsWith("}")?e[t]=safeEval.call(e,r.slice(1,-1)):e[t]=r},initHtml$1=e=>{if(!e.init_){if(e.init_=1,!e.constructor.html_)throw new XElementError("XElement .html property must be set to a non-empty string.");if(e.parentNode&&getXAttrib$1(e.parentNode,"loop"))return e.parentNode.loopHtml=e.constructor.html_.trim(),!1;XElement$1.disableBind++;var t=createEl(e.constructor.html_.trim());XElement$1.disableBind--;for(let r of t.attributes)e.definitionAttributes[r.name]=r.value;for(let t of e.attributes)e.instantiationAttributes[t.name]=t.value;for(let r of t.attributes)r.name&&setAttribute$1(e,r.name,r.value);bindElEvents$1(e,e,null,!1,t);for(let t in e.instantiationAttributes)setAttribute$1(e,t,e.instantiationAttributes[t]);let n=e.constructor.shadowMode;if(n||(n="open"),"open"===n||"closed"===n)for(e.attachShadow({mode:n});t.firstChild;)e.shadowRoot.insertBefore(t.firstChild,null);else{var r=e.innerHTML,l=t.querySelector("#slot");if(l&&l.removeAttribute("id"),l||!r)for(e.innerHTML="";t.firstChild;)e.appendChild(t.firstChild);r&&((l||e).innerHTML=r)}var i=e.shadowRoot||e;for(let e of i.querySelectorAll("link"))for(let t of document.styleSheets)if(t.href===e.href){e.parentNode.replaceChild(XElement$1.createEl("<style>"+Array.from(t.cssRules).map(e=>e.cssText).join("\n")+"</style>"),e);break}for(let t of i.querySelectorAll("[id]")){let r=t.getAttribute("id");if(r in e&&e[r]instanceof Function)throw new XElementError('Cannot set property "'+r+'" on "'+e.constructor.name+'" because there is already a class method with the same name.');Object.defineProperty(e,r,{enumerable:1,configurable:1,get:()=>t,set:()=>{throw new XElementError("Property "+r+" not writable")}}),e.shadowRoot||t.removeAttribute("id")}0===XElement$1.disableBind&&(bindElProps$1(e,e),bindElEvents$1(e,i,null,!0)),e.initialized=!0}};class XElement$1 extends HTMLElement{constructor(){try{super()}catch(e){throw e instanceof TypeError&&(e.message+='\nMake sure to set the .html property before instantiating the class "'+this.name+'".'),e}this.parent=void 0,this.definitionAttributes={},this.instantiationAttributes={};let e=getXName$1(this.constructor),t=this;customElements.get(e)?initHtml$1(t):customElements.whenDefined(e).then(()=>{initHtml$1(t)})}getWatchedPaths(e,t){return e=addThis(replaceVars(e,t),t),parseVars(e).map(e=>getRootXElement$1(this,e))}}Object.defineProperty(XElement$1,"html",{get:()=>(void 0).html_,set:function(e){return customElements.define(getXName$1(this),this),this.html_=e.trim()}}),XElement$1.disableBind=0,XElement$1.bindings=bindings,XElement$1.createEl=createEl,XElement$1.getXParent=getXParent$1,XElement$1.removeProxy=removeProxy,XElement$1.cleanup=()=>{elWatches$1=new WeakMultiMap,elEvents$1=new WeakMultiMap},window.xdebug=e=>e,window.xlog=e=>(console.log(e),e);export{XElement$1 as XElement,bindEl$1 as bindEl,elEvents$1 as elEvents,elWatches$1 as elWatches,getRootXElement$1 as getRootXElement,getXParent$1 as getXParent,removeProxy,unbindEl$1 as unbindEl,unwatch};
//# sourceMappingUrl=XElement.min.js.map
